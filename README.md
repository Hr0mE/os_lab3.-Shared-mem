# Лабораторная работа 3: Менеджер процессов с разделяемой памятью

## Описание задания

Кроссплатформенная программа (POSIX, Windows) на C, которая:

1. **При старте** открывает лог-файл и записывает свой PID и время запуска
2. **Каждые 300 мс** увеличивает общий счетчик на 1
3. **Позволяет пользователю** установить любое значение счетчика (через интерфейс командной строки)
4. **Каждую секунду** (только главный процесс) записывает в лог: время, PID и значение счетчика
5. **Каждые 3 секунды** (только главный процесс) запускает 2 копии программы:
   - **Копия 1**: увеличивает счетчик на 10
   - **Копия 2**: умножает счетчик на 2, ждет 2 секунды, делит на 2
   - Если копия еще не завершилась, новая не запускается (логируется)
6. **Множественные экземпляры**: можно запустить несколько программ:
   - Только одна становится "главной" (master) - логирует и порождает копии
   - Все экземпляры модифицируют общий счетчик каждые 300 мс

## Архитектура

### Модульная структура

- **platform.c/h** - кроссплатформенный слой (Windows/POSIX)
  - Shared memory (CreateFileMapping / shm_open)
  - Мьютексы (CreateMutex / pthread_mutex_t с PTHREAD_PROCESS_SHARED)
  - Процессы (CreateProcess / fork+execl)
  - Таймеры и время

- **shared.c/h** - управление разделяемой памятью
  - Счетчик с атомарными операциями
  - Статус master процесса
  - Флаги выполнения копий

- **app.c/h** - логика приложения
  - Таймеры (300ms, 1s, 3s)
  - Логирование
  - Запуск дочерних процессов

- **main.c** - точка входа

### Режимы работы

- **MODE_NORMAL (0)** - обычный режим с таймерами
- **MODE_COPY1 (1)** - копия 1 (+10 к счетчику)
- **MODE_COPY2 (2)** - копия 2 (*2, ждать, /2)

## Компиляция

### Linux/macOS

```bash
chmod +x scripts/build_linux.sh
./scripts/build_linux.sh
```

### Windows

```cmd
scripts/build_windows.cmd
```

## Запуск

### Один процесс

```bash
cd build/bin
./lab3_main
```

### Несколько процессов (демонстрация master/slave)

```bash
cd build/bin
./lab3_main &
./lab3_main &
./lab3_main &
```

Первый запущенный процесс станет главным (MASTER), остальные - подчиненными (SLAVE).

### Интерактивные команды

Во время работы программы можно вводить команды:

```bash
get           # Получить текущее значение счетчика
set 100       # Установить счетчик в 100
quit          # Выйти из программы
```

Пример:
```
$ ./lab3_main
Process 12345: MASTER mode
...
get
Counter = 15
set 500
Counter set to 500
quit
Exiting...
```

## Работа программы

### Логирование

Все события записываются в `lab3/logs/process.log`:

```
[2026-01-17 15:30:45.123] [PID:12345] Process started (mode=0)
[2026-01-17 15:30:45.124] [PID:12345] Became MASTER process
[2026-01-17 15:30:46.124] [PID:12345] Timer 1s: counter = 3
[2026-01-17 15:30:48.125] [PID:12345] Spawned Copy1 with PID 12346
[2026-01-17 15:30:48.125] [PID:12345] Spawned Copy2 with PID 12347
[2026-01-17 15:30:48.226] [PID:12346] Copy1 started
[2026-01-17 15:30:48.227] [PID:12346] Copy1: counter += 10, new value = 13
[2026-01-17 15:30:48.228] [PID:12346] Copy1 exiting
```

### Таймеры

- **300 мс**: все процессы увеличивают счетчик на 1
- **1 сек**: главный процесс логирует текущее значение
- **3 сек**: главный процесс запускает копии (если предыдущие завершились)

### Синхронизация

Используется shared memory с мьютексами для безопасного доступа к счетчику из разных процессов.
